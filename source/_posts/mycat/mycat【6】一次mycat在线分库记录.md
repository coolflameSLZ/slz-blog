---
title: mycat【6】一次mycat在线分库记录
toc: true
categories:
  - 数据库
  - mycat 
tags:
  - 中间件
  - 分库分表
  - mycat
hide: false
sortn: 60
date: 2021-08-01 16:41:56
---

这是一次 使用mycat 不停机扩容的纪录片

<!-- more -->

------



# 一次mycat在线分库记录



## 分发服务分表方案



### 目标：

1. （核心目标）解决分发服务的数据库性能问题；

2. （非核心目标） 输出相对通用的分库分表技术方案；

3. （非核心目标） 了解学习本地技术架构与业务实现方案；

   

### 验收条件：

1. （强约束） 控制表规模；
2. （强） 整体稳定可靠，出问题可监控可排查；
3. （弱） 方案及经验可推广到别的项目；



### 下面有三个分表策略

1. 根据日期（月份） 进行哈希，确定取模天数 tran_1  、trans_2 、 tran_3 等
2. 根据近期时间范围，近n个月的在一张表里面， 其他的在另一个表里面。 trans_1(30天内数据),、trans_2(30天外的数据，1号冷库)、trans_2(30天外的数据，2号冷库)
3. 按照日期进行枚举拆分，比如 trans_2019_01 、trans_2019_02 、trans_2019_01 等

下面对比：

| 对比项                           | 方案1                  | 方案2                                                        | 方案3                      |
| -------------------------------- | ---------------------- | ------------------------------------------------------------ | -------------------------- |
| 拆分逻辑                         | 日期取模（取模天数>2） | 近期、远期拆分<br>（热数据单独一个库，<br>冷数据进行日期范围分库） | 日期范围拆分               |
| 数据平均程度                     | 平均                   | 不平均                                                       | 平均                       |
| 冷热数据隔离性                   | 一般                   | 好                                                           | 好                         |
| 清理热数据是否方便               | 不方便                 | 方便                                                         | 方便                       |
| 清理冷数据是否方便               | 不方便                 | 方便                                                         | 方便                       |
| 随着数据规模<br>后续是否需要扩容 | 需要                   | 几乎不需要                                                   | 不需要                     |
| 优点                             | 通用套路               | 冷热数据分离性强，<br>在冷数据数据查询极少的情况下，<br>可以有效降低负载 | 隔离性强<br>               |
| 缺点                             | 无法做到冷热数据分离   | 操作简单，维护容易<br>但要解决冷热数据的迁移问题             | 需要滚动建表，维护起来麻烦 |

#### 方案选型总结：

- 方案一：取模法，通用，简单。
- 方案二：可以冷热分离，但需要解决数据迁移问题
- 方案三：拆分粒度细，需要提前建表

最终选择，取模法。



#### 实施步骤记录：

1. 分发服务，目前没有日期枚举字段，下一个迭代：

   1. 需要加上日期的枚举字段。并修改 select 语句 ，update by id 的时候 加上 日期条件。（评估业务可行性）
   2. 实现双写，单读 （读写trans，写trans_side）
   3. 进行mycat 配置。
   4. 开始数据拷贝作业，使用data-x 同步数据，将旧数据拷贝至新的两个子库。
2. 迭代 app->app_v2，读写旧库，写新库。
3. 观察mycat 写入双写数据的情况，尤其是看双写，是否会带来数据不一致，比如旧库成功，新库失败
4. 迭代 mycat -> mycat_v3 ，将 trans_side，和trans 改名，app_v2的数据源就无需改变
5. 观察读取情况，开是否有数据不一致产生
6. 迭代app -> app_v3，此时将 trans_side 数据源的旁写逻辑去除即可。



![步骤2，迭代app](https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210801170823.png)

![步骤4，迭代mycat](https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210801170841.png)

![步骤6，迭代app](https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210801170851.png)
