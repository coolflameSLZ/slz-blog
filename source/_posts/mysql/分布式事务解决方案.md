---
title: '分布式事务解决方案'
toc: true
categories:
  - 数据库
  - mysql
tags:
  - 分库分表
  - 分布式事务
hide: false
date: 2021-07-31 22:02:41
sortn: 40
---

这是摘要
<!-- more -->

------



## 分布式事务常见解决方案



### 强一致协议

- 两阶段提交 2PC、三阶段提交 3PC

  <img src="https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210731230311.png" style="zoom:33%;" />

- 落地方案：

  - XA规范，是对两阶段提交的实现方案<br>资源管理器 - 事务参与者<br>事务管理器 - 事务协调者

  - XA规范，有十倍的性能衰减。

    - 有写锁，提交周期比较长

    - 要求事务管理器，需要本地记录事务状态，机器挂了后，就不支持异地恢复。

      

### 柔性事务



- TCC 规范 （Try - Confirm - Cancel）
  - 尝试执行业务，预留资源<br>确认执行业务，使用Try阶段资源<br>取消执行业务，释放Try阶段预留的资源
  - 缺点：
    - 业务逻辑复杂，新手不会写，老人写出来不能保证没bug。
    - 这种东西，测试也不太好测试，线上风险太大。
    - 业务逻辑写出bug的风险，比不同分布式事务，出问题的概率还要大得多
  - TCC协议中，没有给出机器Try后，机器掉电的异常情况的处理方案，<br>本质上是个有缺陷的协议
- SAGA模型
  - 一个分布式事务拆分为多个本地事务<br>本地事务都有相应的执行模块和补偿模块<br>事务管理器负责在事务失败时调度执行补偿逻辑;
  - 缺点：
    - 一个业务及要写正向业务逻辑，也要写出现异常的业务逻辑，工作量翻倍
    - 即使有事务协调器，不能保证异常恢复逻辑，被精确一次执行，比如事务管理器，收到的异常执行结果为超时。
    - 需要保证反向业务的幂等性，工作量也翻倍。
    - 当异常回滚逻辑，第一次执行失败后，依然免不了人工介入。



### 事务消息

- 简化了分布式事务的模型，对业务友好

- rocketMQ就有事务消息，可以拿来即用。

  

### Seata 分布式事务流程

- **Seata 2PC模型**

![image-20210731232847753](https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210731232847.png)



- **seata AT模型**

  - 介绍
    - 一种无侵入的分布式事务解决方案，2PC的广义实现。 
    - 源自阿里云GTS AT模式的开源版。
  - 核心价值
    - 低成本 : 编程模型不变，轻依赖不需要为分布式事务场景做特定设计。
    - 高性能 : 一阶段提交，不阻塞;连接释放，保证整个系统的吞吐。
    - 高可用 : 极端的异常情况下，可以暂时跳过异常事务，保证系统可用。
  - 实现方案

  <img src="https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210731233319.png" alt="image-20210731233319236" style="zoom:50%;" />

![image-20210731233418204](https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210731233418.png)

