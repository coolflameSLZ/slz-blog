---
title: 注册中心的设计与选型
toc: true
categories:
  - 后端
tags:
  - 注册中心
  - 设计
hide: true
date: 2021-07-31 23:47:39
---

这是摘要
<!-- more -->

------



# 注册中心的设计与选型



### 没有注册中心的解决方案

- 通过全局配置文件，来规定服务ip的调用关系。<br>迁移、扩容的时候非常痛苦。



### 注册中心，需要实现的点



#### 注册中心的主要功能

- 获取服务信息比如：
  - 路由信息，服务注册节点的IP，端口。
  - 服务元数据信息，序列化协议，负载均衡规则，节点权重等



- 服务发现，节点刷新的方案：

  - 启动时拉：消费方启动后，先从注册中心获取提供方的节点列表

  - 通知回调：提供方的节点变更时，主动调用消费方，让消费方重新拉取节点数据

  - 轮询拉取：回调不一定总是成功，所以需要兜底策略：轮询，分钟级别。

    

- 主动通知调用方，服务节点发生变更



#### 健康检查

- 一般情况下的服务失效原因

  1. 部署重启，正常下线，可以主动通知注册中心
  2. 服务异常终止，比如机器掉电，无法主动通知下线事件
  3. 服务假死（注册中心线程可用，但工作线程不可用，表现起来就是依然可用向注册中心发心跳，但业务接口已经卡死不可用。）

  

- 注册中心监控不健康节点的方案

  - 主动下线，能解决1 
  - 心跳上报，能解决 1，2
  - 注册中心，主动探活，探测工作线程是否可用。能解决 1，2，3
  - consumer 通过正常调用，也可以感知到对方服务是否假死。<br>也通过consumer上报异常，解决  1，2，3

  

### 注册中心的实现方案

#### 业务模型

- 消费者视角，主要关心的是服务的提供者的ip地址。
- 提供者的角度，主要关系的是，本服务被哪些消费者注册消费了，方便提供者节点上下线的时候，主动通知消费者

```json
{
    "providerList": [
        {
            "serverName": "orderSvr",
            "consumerList": "userSvr,addrSvr,productSvr"
        },
        {
            "serverName": "addrSvr",
            "consumerList": "userSvr,addrSvr,productSvr"
        }
    ],
    "consumerList": [
        {
            "serverName": "userSvr",
            "providerList": "orderSvr,addrSvr,productSvr"
        },
        {
            "serverName": "orderSvr",
            "providerList": "userSvr,addrSvr,productSvr"

        }
    ],
    "ipList": [
        {
            "serverName": "orderSvr",
            "ipList": "xxxx,xxxx,xxxx",
            "port": "8081"
        },
        {
            "serverName": "userSvr",
            "ipList": "xxxx,xxxx,xxxx",
            "port": "8082"
        }
    ]
}
```



### 超时处理

- 遍历扫描，以前的微服务注册中心，使用该方法即可，因为节点不多。

- 动态分组算法，节点数量较多时使用，一般应用在 IM 中 长连接 keepalive 超时主动清理的扫描机制， 节点以10万为单位。遍历肯定不行

  <img src="https://cdn.jsdelivr.net/gh/coolflameSLZ/img/img20210801012443.png" alt="image-20210801012442966" style="zoom:33%;" />



1. 该数据模型，如果n秒超时，有n个bucket。比如1分钟超时，就有60个bucket。
2. 这样每一个连接的超时时间，就能确定的放到某一个bucket里面，比如现在是53秒，有一个新的连接进来，那么新的连接就要放到
3. 有一个游标一直轮询bucket，

【疑问，】



## 开源注册中心选型





## Nacos注册中心深入分析



511288880

## Zookeeper实现深入剖析
